# 测试指南 - 用户数据隔离功能

## 🧪 快速测试步骤

### 前置条件
- ✅ 已部署云函数 `login`
- ✅ 已创建云数据库集合 `users`
- ✅ 已创建云存储文件夹 `avatar`

---

## 测试 1：未登录状态

### 操作步骤
1. 清除小程序缓存（开发工具 → 清除缓存 → 清除数据缓存）
2. 重新编译运行

### 预期结果
- ✅ **首页**：显示空状态，酒杯图标 + "还没有记录哦"
- ✅ **个人页**：
  - 头像显示灰色默认图标 👤
  - 昵称显示 "点击登录"
  - 统计数据全部为 0
  - 照片墙显示 "创建笔记来丰富你的照片墙吧"
- ✅ **点击 + 按钮**：可以进入编辑页，但保存时会提示 "请先登录"

---

## 测试 2：测试账号登录（有 Mock 数据）

### 操作步骤
1. 在个人页点击头像区域
2. 授权微信登录
3. 确保登录的是测试账号：`ox5U-1w7Hp6gfsPofPY0srdA38K8`

### 预期结果
- ✅ **登录成功**：显示 "登录成功" Toast
- ✅ **首页**：自动显示 5 条 Mock 数据
- ✅ **个人页**：
  - 显示用户头像和昵称
  - 统计数据正确（总杯数 5、总花费、记录天数）
  - 照片墙显示 5 张图片
- ✅ **可以正常创建、编辑、删除笔记**

---

## 测试 3：新账号登录（无数据）

### 操作步骤
1. 如果当前已登录，先退出登录
2. 使用**另一个微信账号**登录（不是测试账号）

### 预期结果
- ✅ **登录成功**
- ✅ **首页**：显示空状态（因为这是新用户，没有笔记）
- ✅ **个人页**：统计数据为 0，照片墙为空
- ✅ **看不到测试账号的 5 条 Mock 数据**（数据隔离成功）

---

## 测试 4：创建笔记并切换账号

### 操作步骤
1. **用户 A** 登录（新账号）
2. 创建一条笔记（例如：名称 "用户A的酒"）
3. 退出登录
4. **用户 B** 登录（另一个新账号）
5. 查看首页和个人页

### 预期结果
- ✅ 用户 A 创建笔记成功
- ✅ 退出登录后，首页和个人页恢复空状态
- ✅ 用户 B 登录后，**看不到用户 A 的笔记**
- ✅ 用户 B 创建自己的笔记（例如：名称 "用户B的酒"）
- ✅ 退出登录
- ✅ 用户 A 重新登录，**只看到自己的笔记**（"用户A的酒"），看不到 "用户B的酒"

---

## 测试 5：退出登录

### 操作步骤
1. 登录任意账号
2. 进入个人信息编辑页
3. 点击 "退出登录"
4. 确认退出

### 预期结果
- ✅ 显示确认弹窗
- ✅ 确认后显示 "已退出登录" Toast
- ✅ 自动返回个人页
- ✅ 个人页显示未登录状态（灰色头像 + "点击登录"）
- ✅ 首页显示空状态
- ✅ 无法创建新笔记（提示 "请先登录"）

---

## 测试 6：个人信息修改

### 操作步骤
1. 登录任意账号
2. 点击个人页头像，进入个人信息编辑页
3. **测试修改头像**：
   - 点击头像行
   - 选择 "从相册选择" 或 "拍照"
   - 上传新头像
4. **测试修改昵称**：
   - 点击昵称行
   - 输入新昵称
   - 确认保存
5. 返回个人页和首页

### 预期结果
- ✅ 头像上传成功，个人信息页立即更新
- ✅ 昵称修改成功，个人信息页立即更新
- ✅ 返回个人页，头像和昵称已更新
- ✅ 首页问候语栏的头像也已更新

---

## 测试 7：未登录时自动触发登录（重要更新）

### 操作步骤
1. 未登录状态下，进入编辑页创建笔记
2. 填写完整信息（上传图片、输入名称、选择评分等）
3. 点击保存按钮

### 预期结果
- ✅ 弹出 Modal："需要登录 - 保存笔记需要登录，是否授权微信登录？"
- ✅ 点击"授权登录"触发微信授权
- ✅ 授权成功后显示"登录中..."
- ✅ 登录成功后自动继续保存
- ✅ 显示"保存成功"并返回首页
- ✅ 首页显示刚创建的笔记
- ✅ 点击"取消"则取消保存，保持未登录状态

---

## 测试 8：云端数据验证

### 操作步骤
1. 登录后创建/修改几条笔记
2. 打开云开发控制台 → 数据库 → `users` 集合
3. 查看当前登录用户的记录

### 预期结果
- ✅ `users` 集合中有当前用户的记录
- ✅ `_id` 字段为用户的 OpenID
- ✅ `nickname` 和 `avatarUrl` 正确

---

## 🐛 常见问题排查

### 问题 1：登录后仍然显示空状态
**可能原因**：
- OpenID 不是测试账号
- Mock 数据未正确关联

**解决方案**：
1. 查看控制台日志，找到实际的 OpenID
2. 修改 `app.js` 中的 `TEST_USER_OPENID` 为实际 OpenID
3. 重新编译

### 问题 2：切换账号后看到其他用户的数据
**可能原因**：
- `storage.js` 的过滤逻辑未生效
- 缓存问题

**解决方案**：
1. 检查 `services/storage.js` 的 `getCurrentUserOpenId()` 是否正常工作
2. 清除缓存，重新登录

### 问题 3：创建笔记失败
**可能原因**：
- 未登录
- `saveLog()` 没有正确添加 `openid`

**解决方案**：
1. 确保已登录
2. 查看控制台错误日志
3. 检查 `storage.js` 的 `saveLog()` 逻辑

---

## 📊 验证清单

复制以下清单用于测试验证：

```
□ 未登录时首页显示空状态
□ 未登录时个人页显示"点击登录"
□ 未登录时创建笔记会自动触发登录
□ 登录后笔记自动保存成功
□ 取消登录则不保存笔记
□ 测试账号登录后显示 5 条 Mock 数据
□ 新账号登录后显示空状态
□ 新账号创建笔记成功
□ 切换账号数据正确隔离
□ 退出登录后数据隐藏
□ 重新登录后数据恢复
□ 修改头像成功
□ 修改昵称成功
□ 编辑笔记成功
□ 删除笔记成功
□ 云数据库 users 集合数据正确
```

---

## 🔧 调试技巧

### 1. 查看当前登录用户
在任意页面的 `onLoad` 或 `onShow` 中添加：
```javascript
const app = getApp();
console.log('当前用户:', app.globalData.userInfo);
```

### 2. 查看本地存储的所有笔记
在控制台执行：
```javascript
const allLogs = wx.getStorageSync('drinking_diary_logs');
console.log('所有笔记:', allLogs);
console.log('各用户笔记数量:', 
  allLogs.reduce((acc, log) => {
    acc[log.openid] = (acc[log.openid] || 0) + 1;
    return acc;
  }, {})
);
```

### 3. 强制清除所有数据
在控制台执行：
```javascript
wx.clearStorageSync();
console.log('已清除所有本地数据');
```

---

**测试完成后**，请将测试结果反馈，包括：
- ✅ 通过的测试项
- ❌ 失败的测试项
- 🐛 发现的问题

**更新时间**: 2025-12-17
