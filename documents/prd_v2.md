# 产品需求文档（PRD）
# 微醺笔记 (Drinking Diary) Phase 2 - 云开发与用户体系

## 1. 产品概述

### 1.1 背景与目标
在完成一期（MVP）的前端功能开发后，二期重点在于引入服务端能力，解决数据持久化、用户身份识别以及多设备同步的基础问题。
本阶段将全面接入 **微信云开发 (WeChat Cloud Development)**，利用其云函数、云数据库和云存储能力，实现用户登录、个人信息管理及数据云端备份功能。
**核心目的**：建立用户体系，确保用户数据的隔离与安全。即不同用户登录后，只能看到并管理自己账号下的笔记数据，实现"千人千面"的个性化记录体验。

### 1.2 二期核心功能范围
本阶段开发内容分为以下三个部分：
1.  **微信登录体系**: 搭建云端基础设施，实现无感/一键登录，完善首页和个人页的登录态响应。
2.  **个人信息编辑页面**: 创建个人信息管理页，支持修改头像和昵称。
3.  **云端数据管理能力**: 实现本地数据手动备份到云端、从云端恢复以及删除云端备份的功能。

---

## 2. 功能架构 (更新)

### 2.1 功能模块图
```
微醺笔记 (Phase 2)
├── Part 1: 微信登录体系
│   ├── 微信登录 (Auth)
│   ├── 首页登录态适配
│   └── 个人页登录态适配
├── Part 2: 个人信息管理
│   ├── 个人信息编辑页 UI
│   ├── 修改头像 (上传云存储)
│   └── 修改昵称 (更新数据库)
└── Part 3: 云端数据管理
    ├── 备份到服务器 (Backup)
    ├── 从服务器恢复 (Restore)
    └── 删除云端备份 (Delete)
```

### 2.2 页面流转图
```
[首页] (Part 1)
   │
   └── (头像) -> [展示状态: 默认/用户头像]

[个人酒库页] (Part 1)
   │
   ├── (未登录) -> 点击头像 -> [微信授权登录] -> 刷新页面显示用户信息
   │
   └── (已登录) -> 点击头像 -> [个人信息编辑页]
```

```
[个人信息编辑页] (Part 2 & 3)
   ├── [Part 2] 个人资料组
   │    ├── 修改头像 (ActionSheet)
   │    └── 修改昵称 (Modal)
   │
   ├── [Part 3] 云端数据组
   │    ├── 备份到服务器
   │    ├── 从服务器恢复
   │    └── 删除云端备份
   │
   └── [Part 1] 退出登录
```

---

## 3. 开发内容详细设计

### Part 1: 微信登录体系

**目标**: 完成云环境初始化，实现用户登录流程，建立用户身份标识，并适配首页和个人酒库页的登录态展示。通过 OpenID 唯一标识用户，确保后续的数据操作（备份/恢复）均严格限制在当前登录用户下，实现数据隔离。

#### 3.1.1 基础设施搭建
- **环境初始化**: 在 `app.js` 中完成 `wx.cloud.init`。
- **云函数**: 创建 `login` 云函数用于获取 openid。
- **数据库**: 创建 `users` 集合 (权限: 仅创建者可读写)。

#### 3.1.2 首页 (Home View) - 状态更新
- **问候语栏右侧头像**:
  - **交互**: 不可点击，仅作为状态展示。
  - **逻辑**: 
    - 未登录: 显示默认的灰色人像图标。
    - 已登录: 自动同步显示用户的云端头像 (avatarUrl)。

#### 3.1.3 个人酒库页 (My Gallery) - 交互更新
- **用户信息区**: 
  - **未登录状态**: 
    - 头像显示默认灰色人像图标。
    - 昵称显示 "点击登录"。
  - **已登录状态**: 
    - 显示用户微信头像。
    - 显示用户微信昵称。

- **点击头像交互**:
  - **IF 未登录**: 
    - 触发 `wx.getUserProfile` (或最新登录API)。
    - **成功**: 
      1. 调用云函数 `login` 获取 OpenID。
      2. 在云数据库 `users` 集合查找或创建用户。
      3. 将用户信息写入本地 Storage (`user_info`)。
      4. 刷新页面显示头像和昵称。
    - **失败**: Toast 提示 "登录已取消"。
  - **IF 已登录**:
    - 跳转至 **[个人信息编辑页]**。

- **退出登录逻辑**:
  - 清除本地 `user_info` 缓存。
  - 重置全局登录状态。
  - 刷新页面UI至未登录态。

---

### Part 2: 个人信息编辑页面

**目标**: 创建二级页面 "个人信息"，实现用户基础资料的修改与保存。

#### 3.2.1 页面容器
- **层级**: 普通二级页面，从右侧滑入。
- **背景**: 系统浅灰 (#F2F2F7)。
- **导航栏**: 标题 "个人信息"，左侧返回箭头。
- **布局风格**: **Inset Grouped (内嵌分组)**。

#### 3.2.2 个人资料卡片组 (Profile Group)
- **位置**: 页面最上方。
- **样式**: 圆角白色背景卡片。
- **Row 1: 头像**:
  - 左侧: 文字 "头像"。
  - 右侧: 用户当前头像 (圆形小图) + 灰色向右箭头。
  - **交互**: 点击触发 **ActionSheet**。
    - 选项: "使用微信头像"、"从相册选择"、"拍照"。
    - **逻辑**: 选择/拍摄 -> 上传云存储 (`cloud://.../avatar/{openid}.jpg`) -> 获取FileID -> 更新 DB `users` -> 更新本地 Storage -> 刷新 UI。
- **Row 2: 昵称**:
  - 左侧: 文字 "昵称"。
  - 右侧: 用户当前昵称 (灰色文字) + 灰色向右箭头。
  - **交互**: 点击触发 **Modal 弹窗**。
    - 标题: "修改昵称"。
    - 内容: 输入框 (当前昵称)。
    - **逻辑**: 保存 -> 校验非空 -> 更新 DB `users` -> 更新本地 Storage -> 刷新 UI。

#### 3.2.3 底部操作
- **退出登录按钮**:
  - 位置: 页面底部。
  - 样式: 独立白色长条，文字红色 (#FF3B30)，居中。
  - 交互: 点击弹窗确认 -> 执行 Part 1 定义的退出逻辑 -> 返回上一页。

---

### Part 3: 云端数据管理能力

**目标**: 实现本地笔记数据的云端备份、恢复与管理。

#### 3.3.1 云端数据卡片组 (Cloud Data Group)
- **位置**: 个人资料卡片组下方。
- **样式**: 圆角白色背景卡片。

#### 3.3.2 功能详解
1.  **备份到服务器**:
    - **UI**: 蓝色云上传图标 + "备份到服务器" + 右侧状态 (如 "上次: 10-24")。
    - **逻辑**: 
      - Loading "备份中..."。
      - 读取本地 Storage `notes`。
      - **关键**: 遍历笔记，识别临时图片路径 -> 上传云存储 -> 获取云路径替换临时路径。
      - 调用云函数/数据库 API，将笔记存入 `notes` 集合 (采用 upsert 策略，以 `id` 为键)。
      - 更新 DB `users.lastBackupAt`。
      - Toast "备份成功"。

2.  **从服务器恢复**:
    - **UI**: 绿色云下载图标 + "从服务器恢复"。
    - **逻辑**:
      - 弹窗确认 "将覆盖本地数据？"。
      - Loading "恢复中..."。
      - 读取云数据库 `notes` 集合。
      - 覆盖写入本地 Storage `notes`。
      - Toast "恢复成功" 并刷新首页数据。

3.  **删除云端备份**:
    - **UI**: 红色垃圾桶图标 + "删除云端备份" (红色文字)。
    - **逻辑**:
      - 弹窗确认 "确定删除云端所有备份？不可恢复"。
      - 调用云函数删除 `notes` 集合中该用户所有数据。
      - Toast "已删除"。

---

## 4. 数据库设计 (Database Schema)

### 4.1 Users 集合 (users)
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| _id | string | OpenID (作为主键) |
| nickname | string | 用户昵称 |
| avatarUrl | string | 云存储中的头像 FileID |
| createdAt | date | 注册时间 |
| lastBackupAt | date | 上次数据备份时间 |

### 4.2 Notes 集合 (notes)
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| _id | string | 笔记唯一ID (与本地ID保持一致) |
| _openid | string | 微信OpenID (系统自动添加，用于数据隔离与权限控制) |
| name | string | 酒名 |
| image | string | 图片FileID (需处理本地临时路径转云存储路径的问题*) |
| rating | number | 评分 |
| tags | array | 标签数组 |
| location | string | 地点 |
| price | number | 价格 |
| description | string | 笔记内容 |
| date | string | 记录日期字符串 (YYYY-MM-DD) |
| createdAt | number | 创建时间戳 |
| updatedAt | number | 更新时间戳 |

---

## 5. 异常处理

### 5.1 通用异常
- **网络异常**: 所有云端操作前检查网络，失败提示 "网络连接失败"。
- **存储空间**: 云存储满时提示用户。

### 5.2 业务异常
- **登录失败**: 用户拒绝授权，保持未登录态。
- **备份冲突**: 尽量使用服务端时间戳判断，MVP阶段简化为覆盖策略。
