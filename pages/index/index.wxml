<!--pages/index/index.wxml-->
<view class="home-page">
  
  <!-- åŠ¨æ€èƒŒæ™¯å±‚ -->
  <view class="bg-layer">
    <image 
      wx:if="{{backgroundImage}}" 
      class="bg-layer__image" 
      src="{{backgroundImage}}" 
      mode="aspectFill"
    />
    <view class="bg-layer__overlay"></view>
  </view>

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="home-header" style="padding-top: {{statusBarHeight}}px; height: {{totalNavHeight}}px;">
    <view class="home-header__blur"></view>
    <view class="home-header__content" style="height: {{navBarHeight}}px;">
      <text class="home-header__title">å¾®é†ºç¬”è®°</text>
    </view>
  </view>

  <!-- é—®å€™è¯­æ  -->
  <view class="greeting-bar" style="top: {{totalNavHeight}}px;">
    <view class="greeting-text">
      <text class="greeting-text__main">{{greeting}}</text>
    </view>
    <view class="greeting-avatar">
      <image 
        class="greeting-avatar__image" 
        src="https://picsum.photos/200/200" 
        mode="aspectFill"
      />
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{isEmpty}}" class="empty-state">
    <text class="empty-state__icon">ğŸ·</text>
    <text class="empty-state__text">è¿˜æ²¡æœ‰è®°å½•å“¦</text>
    <text class="empty-state__hint">ç‚¹å‡» + æŒ‰é’®å¼€å§‹è®°å½•ç¬¬ä¸€æ¯é…’</text>
  </view>

  <!-- å¡ç‰‡æµï¼ˆå‚ç›´Swiper + æ°´å¹³å †å ï¼‰ -->
  <view wx:else class="card-flow" style="top: {{totalNavHeight + 60}}px;">
    <!-- å¤–å±‚å‚ç›´Swiperï¼ˆæ—¥æœŸåˆ†ç»„ï¼‰ -->
    <swiper 
      class="vertical-swiper"
      vertical="{{true}}"
      current="{{activeGroupIndex}}"
      bindchange="onVerticalChange"
      duration="400"
      circular="{{false}}"
    >
      <block wx:for="{{groupedLogs}}" wx:key="date" wx:for-item="group" wx:for-index="groupIndex">
        <swiper-item class="vertical-item">
          
          <!-- å¡ç‰‡å †å å®¹å™¨ï¼ˆæ°´å¹³æ‰‹åŠ¿æ§åˆ¶ï¼‰ -->
          <view 
            class="card-stack-container"
            data-group-index="{{groupIndex}}"
            bindtouchstart="onTouchStart"
            bindtouchmove="onTouchMove"
            bindtouchend="onTouchEnd"
            catch:tap="preventBubble"
          >
            <block wx:for="{{group.logs}}" wx:key="id" wx:for-item="log" wx:for-index="logIndex">
              <view 
                class="diary-card-wrapper diary-card-wrapper--offset-{{logIndex - (activeLogIndices[groupIndex] || 0)}}"
                data-id="{{log.id}}"
                data-offset="{{logIndex - (activeLogIndices[groupIndex] || 0)}}"
                bindtap="onCardTap"
              >
                <!-- å¡ç‰‡ -->
                <view class="diary-card">
                  <!-- å›¾ç‰‡åŒºåŸŸ -->
                  <view class="card-image">
                    <image 
                      class="card-image__img" 
                      src="{{log.imagePath || log.imageUrl}}" 
                      mode="aspectFill"
                      lazy-load
                      binderror="onImageError"
                    />
                  </view>

                  <!-- ä¿¡æ¯åŒºåŸŸ -->
                  <view class="card-info">
                    <view class="card-header">
                      <text class="card-title">{{log.name}}</text>
                      <view class="card-rating">
                        <block wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
                          <text class="card-star {{log.rating >= item ? 'card-star--filled' : ''}}">â˜…</text>
                        </block>
                      </view>
                    </view>

                    <text class="card-description">{{log.notes || 'æš‚æ— æè¿°'}}</text>

                    <view class="card-footer">
                      <view class="card-tags">
                        <block wx:for="{{log.tags}}" wx:key="*this" wx:if="{{index < 3}}">
                          <text class="card-tag">{{item}}</text>
                        </block>
                      </view>
                      <text class="card-time">{{log.displayTime}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </block>
          </view>
          
        </swiper-item>
      </block>
    </swiper>

    <!-- æ—¥æœŸæŒ‡ç¤ºå™¨ -->
    <view class="date-indicators">
      <block wx:for="{{groupedLogs}}" wx:key="date" wx:for-index="idx">
        <view class="date-indicator {{activeGroupIndex === idx ? 'date-indicator--active' : ''}}">
          <text wx:if="{{activeGroupIndex === idx}}" class="date-indicator__text">{{item.displayDate}}</text>
          <view wx:else class="date-indicator__dot"></view>
        </view>
      </block>
    </view>
  </view>

</view>
